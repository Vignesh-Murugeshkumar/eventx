<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eventx — Hackathon Ready</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { DEFAULT: '#6366f1', dark: '#4f46e5' } },
          boxShadow: { glow: '0 10px 40px rgba(99,102,241,0.25)' },
        }
      }
    }
  </script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- XLSX Export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    html,body {height:100%}
    body {font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .link {color:#6366f1}
    .card { @apply bg-white/80 backdrop-blur shadow-lg rounded-2xl p-5 border border-slate-200 }
    .btn { @apply inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2 font-medium transition active:scale-[0.98]; }
    .btn-primary { @apply btn bg-brand text-white hover:bg-brand-dark shadow-glow; }
    .btn-ghost { @apply btn bg-transparent hover:bg-slate-100; }
    .input { @apply w-full rounded-xl border border-slate-300 bg-white px-3 py-2 outline-none focus:ring-2 focus:ring-brand; }
    .badge { @apply inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-xs font-medium; }
    .fade-in { animation: fade .3s ease-out both }
    @keyframes fade { from {opacity:0; transform:translateY(6px)} to {opacity:1; transform:none} }
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-slate-50 to-indigo-50 text-slate-900">
  <!-- App Root -->
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
      <div class="max-w-6xl mx-auto px-4 h-16 grid grid-cols-3 items-center">
        <nav class="flex items-center gap-2">
          <a href="#/" class="btn btn-ghost hidden sm:inline-flex">Home</a>
          <a href="#/dashboard" class="btn btn-ghost hidden sm:inline-flex">Dashboard</a>
        </nav>
        <div class="flex items-center justify-center">
          <a href="#/" class="font-black tracking-tight text-2xl sm:text-3xl select-none">Eventx</a>
        </div>
        <div class="flex items-center justify-end gap-2" id="authArea"></div>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1">
      <section id="view" class="max-w-6xl mx-auto px-4 py-8"></section>
    </main>

    <!-- Footer -->
    <footer class="border-t mt-10">
      <div class="max-w-6xl mx-auto px-4 py-6 text-sm text-slate-500 flex flex-wrap items-center justify-between gap-3">
        <p>© <span id="year"></span> Eventx. Hackathon-ready single-file app.</p>
        <div class="flex items-center gap-2">
          <a class="underline" href="#/about">About</a>
          <a class="underline" href="#/terms">Terms</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- Toasts -->
  <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 hidden"></div>

  <script>
  // --------------------
  // Tiny SPA Framework
  // --------------------
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const routes = {};
  const view = $('#view');
  const authArea = $('#authArea');

  function route(path, handler){ routes[path]=handler }
  function navigate(path){ location.hash = path }
  window.addEventListener('hashchange', render);

  function setToast(msg, ok=true){
    const t = $('#toast');
    t.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl text-sm text-white shadow-lg ${ok?'bg-emerald-600':'bg-rose-600'}`;
    t.textContent = msg; t.style.display='block';
    setTimeout(()=> t.style.display='none', 1800);
  }

  // --------------------
  // Storage & Models
  // --------------------
  const DB_KEY = 'eventhub_db_v1';
  const USERS_KEY = 'eventhub_users_v1';
  const SESSION_KEY = 'eventhub_session_v1';

  function load(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback } catch { return fallback } }
  function save(key, value){ localStorage.setItem(key, JSON.stringify(value)) }

  const db = {
    events: load(DB_KEY, []), // {id,title,description,category,date_time,venue,max,organiser_email,is_published,participants:[{id,user_email,name,ticket,qty,paid,amount,created_at}]}
  }
  const users = load(USERS_KEY, []); // {email, password, role, name}
  let session = load(SESSION_KEY, null); // {email, role, name}

  function persist(){ save(DB_KEY, db.events); save(USERS_KEY, users); save(SESSION_KEY, session) }

  function uid(){ return crypto.randomUUID ? crypto.randomUUID() : (Date.now()+""+Math.random()).replace('.','') }

  // Seed a demo organiser and sample event (first run)
  if(users.length === 0){
    users.push({ email:'organiser@example.com', password:'organiser123', role:'organiser', name:'Demo Organiser' });
    users.push({ email:'student@example.com', password:'student123', role:'student', name:'Demo Student' });
    const eId = uid();
    db.events.push({
      id:eId,
      title:'AI & Robotics Expo',
      description:'Showcase of cutting-edge student projects in AI and robotics.',
      category:'Tech',
      date_time:new Date(Date.now()+86400000).toISOString(),
      venue:'Main Auditorium',
      max:120,
      organiser_email:'organiser@example.com',
      is_published:true,
      participants:[],
      created_at:new Date().toISOString(),
      updated_at:new Date().toISOString(),
    });
    persist();
  }

  // --------------------
  // Auth
  // --------------------
  function signUp({email,password,role,name}){
    if(users.find(u=>u.email===email)) throw new Error('Email already registered');
    if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) throw new Error('Invalid email');
    if(password.length<6) throw new Error('Password must be 6+ chars');
    users.push({email,password,role,name:name||''});
    session = {email, role, name:name||email.split('@')[0]};
    persist();
    return session;
  }
  function signIn({email,password}){
    const u = users.find(u=>u.email===email && u.password===password);
    if(!u) throw new Error('Invalid credentials');
    session = {email:u.email, role:u.role, name:u.name||u.email.split('@')[0]};
    persist();
    return session;
  }
  function signOut(){ session=null; persist(); renderHeader(); navigate('#/') }

  function requireAuth(role){
    if(!session){ navigate('#/login'); setToast('Please login/register first', false); return false }
    if(role && session.role!==role){ setToast('Access denied for this role', false); return false }
    return true;
  }

  // --------------------
  // UI Fragments
  // --------------------
  function renderHeader(){
    const auth = session ? `
      <span class="hidden sm:flex items-center gap-2 text-slate-700">
        <i data-lucide="user" class="w-4 h-4"></i>
        <span class="max-sm:hidden">${session.name || session.email}</span>
        <span class="badge border-slate-300">${session.role}</span>
      </span>
      <button class="btn btn-primary" onclick="navigate('#/dashboard')">Dashboard</button>
      <button class="btn btn-ghost" onclick="signOut()">Logout</button>
    ` : `
      <a href="#/login" class="btn btn-primary">Login</a>
    `;
    authArea.innerHTML = auth;
    lucide.createIcons();
  }

  function field(id,label,type='text',attrs=''){
    return `
      <label class="block text-sm font-medium">${label}
        <input id="${id}" type="${type}" class="input mt-1" ${attrs} />
      </label>`
  }

  function pill(text){ return `<span class="badge border-slate-300">${text}</span>` }

  // --------------------
  // Home / Search
  // --------------------
  route('#/', () => {
    const q = new URLSearchParams(location.hash.split('?')[1]||'').get('q')||'';
    const list = db.events.filter(e=> e.is_published && (
      !q || [e.title,e.category,e.venue].join(' ').toLowerCase().includes(q.toLowerCase())
    ));

    view.innerHTML = `
      <div class="py-6">
        <div class="text-center max-w-3xl mx-auto mb-8">
          <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Discover and Register for <span class="text-brand">Events</span></h1>
          <p class="text-slate-600 mt-2">Search, register, and manage events with an engaging, interactive UI.</p>
        </div>
        <div class="max-w-3xl mx-auto mb-8 flex gap-3">
          <input id="search" class="input flex-1" placeholder="Search by name, category, or venue" value="${q}" />
          <button class="btn btn-primary" onclick="doSearch()"><i data-lucide=search class=w-4 h-4></i>Search</button>
        </div>

        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5">
          ${list.map(renderEventCard).join('') || emptyState('No events found')}
        </div>
      </div>
    `;
    lucide.createIcons();
    $('#search').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch() })
  });
  function doSearch(){
    const q = $('#search').value.trim();
    navigate(`#/?q=${encodeURIComponent(q)}`);
    render();
  }
  function renderEventCard(e){
    const regCount = e.participants.filter(p=>p.paid).reduce((a,b)=>a+(b.qty||1),0);
    const slotsLeft = Math.max(0, (e.max||0) - regCount);
    return `
    <article class="card fade-in">
      <div class="flex items-start justify-between gap-4">
        <h3 class="font-bold text-lg">${e.title}</h3>
        ${e.is_published? pill('Published'): pill('Draft')}
      </div>
      <p class="text-sm text-slate-600 mt-1 line-clamp-2">${e.description||''}</p>
      <div class="mt-3 text-sm flex flex-wrap gap-2 text-slate-700">
        <span class="inline-flex items-center gap-1"><i data-lucide=calendar class=w-4 h-4></i> ${new Date(e.date_time).toLocaleString()}</span>
        <span class="inline-flex items-center gap-1"><i data-lucide=map-pin class=w-4 h-4></i> ${e.venue}</span>
      </div>
      <div class="mt-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          ${pill('Max: '+(e.max||0))}
          ${pill('Registered: '+regCount)}
          ${pill('Slots left: '+slotsLeft)}
        </div>
        <div class="flex gap-2">
          <a href="#/event/${e.id}" class="btn btn-ghost">Details</a>
          <button class="btn btn-primary" onclick="goRegister('${e.id}')">Register</button>
        </div>
      </div>
    </article>`
  }
  function emptyState(text){
    return `<div class="col-span-full text-center py-12 text-slate-500">${text}</div>`
  }

  // --------------------
  // Auth Page (Students & Organisers)
  // --------------------
  route('#/auth', ()=>{
    view.innerHTML = `
      <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-6">
        <div class="card">
          <h2 class="text-xl font-bold">Login</h2>
          <div class="mt-4 space-y-3">
            ${field('li_email','Email','email')}
            ${field('li_password','Password','password')}
            <button class="btn btn-primary w-full" onclick="onLogin()">Login</button>
          </div>
        </div>
        <div class="card">
          <h2 class="text-xl font-bold">Register</h2>
          <div class="mt-4 space-y-3">
            ${field('su_name','Name')}
            ${field('su_email','Email','email')}
            ${field('su_password','Password (6+ chars)','password')}
            <label class="block text-sm font-medium">Role
              <select id="su_role" class="input mt-1">
                <option value="student">Student</option>
                <option value="organiser">Organiser</option>
              </select>
            </label>
            <button class="btn btn-primary w-full" onclick="onRegister()">Create Account</button>
          </div>
        </div>
      </div>`;
    lucide.createIcons();
  })

  window.onLogin = function(){
    try {
      const email = $('#li_email').value.trim();
      const password = $('#li_password').value;
      signIn({email,password});
      setToast('Welcome back!');
      renderHeader();
      navigate('#/dashboard');
    } catch(err){ setToast(err.message, false) }
  }
  window.onRegister = function(){
    try {
      const name = $('#su_name').value.trim();
      const email = $('#su_email').value.trim();
      const password = $('#su_password').value;
      const role = $('#su_role').value;
      signUp({email,password,role,name});
      setToast('Account created!');
      renderHeader();
      if(role==='organiser') navigate('#/dashboard'); else navigate('#/');
    } catch(err){ setToast(err.message, false) }
  }

  // --------------------
  // Login & Register (separate pages)
  // --------------------
  route('#/login', ()=>{
    view.innerHTML = `
      <div class=\"max-w-md mx-auto card\">
        <h2 class=\"text-2xl font-black\">Login</h2>
        <p class=\"text-slate-600 text-sm mt-1\">Welcome back to <b>Eventx</b>.</p>
        <div class=\"mt-4 space-y-3\">
          ${field('li_email','Email','email')}
          ${field('li_password','Password','password')}
          <button class=\"btn btn-primary w-full\" onclick=\"onLogin()\">Login</button>
          <p class=\"text-xs text-slate-600 text-center\">Not registered? <a class=\"underline\" href=\"#/register\">Register here</a></p>
        </div>
      </div>`;
    lucide.createIcons();
  })

  route('#/register', ()=>{
    view.innerHTML = `
      <div class=\"max-w-md mx-auto card\">
        <h2 class=\"text-2xl font-black\">Create your account</h2>
        <p class=\"text-slate-600 text-sm mt-1\">Join <b>Eventx</b> as student or organiser.</p>
        <div class=\"mt-4 space-y-3\">
          ${field('su_name','Name')}
          ${field('su_email','Email','email')}
          ${field('su_password','Password (6+ chars)','password')}
          <label class=\"block text-sm font-medium\">Role
            <select id=\"su_role\" class=\"input mt-1\">
              <option value=\"student\">Student</option>
              <option value=\"organiser\">Organiser</option>
            </select>
          </label>
          <button class=\"btn btn-primary w-full\" onclick=\"onRegister()\">Create Account</button>
          <p class=\"text-xs text-slate-600 text-center\">Already have an account? <a class=\"underline\" href=\"#/login\">Login here</a></p>
        </div>
      </div>`;
    lucide.createIcons();
  })

  // --------------------
  // Event Details & Registration (Student)
  // --------------------
  route('#/event/:id', (params)=>{
    const e = db.events.find(x=>x.id===params.id);
    if(!e){ view.innerHTML = emptyState('Event not found'); return }
    const regCount = e.participants.filter(p=>p.paid).reduce((a,b)=>a+(b.qty||1),0);
    const slotsLeft = Math.max(0, (e.max||0) - regCount);

    view.innerHTML = `
      <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 card">
          <h2 class="text-2xl font-extrabold">${e.title}</h2>
          <p class="text-slate-700 mt-2">${e.description||''}</p>
          <div class="mt-4 flex flex-wrap gap-3 text-sm">
            ${pill('Category: '+(e.category||'General'))}
            ${pill('Date: '+new Date(e.date_time).toLocaleString())}
            ${pill('Venue: '+e.venue)}
          </div>
        </div>
        <aside class="card">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-slate-500">Slots left</div>
              <div class="text-2xl font-bold">${slotsLeft}</div>
            </div>
            <div>
              <div class="text-sm text-slate-500">Registered</div>
              <div class="text-2xl font-bold">${regCount}</div>
            </div>
          </div>
          <button class="btn btn-primary w-full mt-4" onclick="goRegister('${e.id}')">Register Now</button>
        </aside>
      </div>`;
    lucide.createIcons();
  })

  window.goRegister = function(eventId){
    if(!session){ navigate('#/login'); setToast('Please login/register first', false); return }
    if(session.role!=='student'){ setToast('Login as student to register', false); return }
    navigate(`#/register/${eventId}`)
  }

  // Registration Wizard (student)
  route('#/register/:id', (params)=>{
    if(!requireAuth('student')) return;
    const e = db.events.find(x=>x.id===params.id);
    if(!e || !e.is_published){ view.innerHTML = emptyState('Event not available'); return }

    view.innerHTML = `
      <div class="max-w-3xl mx-auto card">
        <h2 class="text-xl font-bold">Register — ${e.title}</h2>
        <ol class="mt-3 flex items-center gap-2 text-sm">
          <li class="badge border-slate-300">1. Details</li>
          <li>→</li>
          <li class="badge border-slate-300">2. Ticket</li>
          <li>→</li>
          <li class="badge border-slate-300">3. Review</li>
          <li>→</li>
          <li class="badge border-slate-300">4. Payment</li>
        </ol>
        <div class="mt-4 grid sm:grid-cols-2 gap-4">
          ${field('st_name','Your Name','text','value="'+(session.name||'')+'"')}
          ${field('st_qty','Quantity','number','min=1 value=1')}
          ${field('st_ticket','Ticket Type','text','placeholder="General"')}
          ${field('st_amount','Amount (₹)','number','min=0 value=0')}
        </div>
        <div class="mt-4">
          <button class="btn btn-primary" onclick="goPayment('${e.id}')">Proceed to Payment</button>
          <button class="btn btn-ghost" onclick="navigate('#/event/${e.id}')">Cancel</button>
        </div>
      </div>`;
  })

  window.goPayment = function(eventId){
    const name = $('#st_name').value.trim();
    const qty = Math.max(1, parseInt($('#st_qty').value||'1'));
    const ticket = $('#st_ticket').value.trim()||'General';
    const amount = Math.max(0, parseFloat($('#st_amount').value||'0'));
    const e = db.events.find(x=>x.id===eventId);
    if(!name){ setToast('Please enter your name', false); return }

    // Simple slots check
    const regCount = e.participants.filter(p=>p.paid).reduce((a,b)=>a+(b.qty||1),0);
    if(regCount + qty > e.max){ setToast('Not enough slots left', false); return }

    // Show mock payment portal
    view.innerHTML = `
      <div class="max-w-lg mx-auto card">
        <h2 class="text-xl font-bold">Payment Portal</h2>
        <p class="text-slate-600 mt-1">UPI/Card/NetBanking (mock). Total: ₹${amount.toFixed(2)}</p>
        <div class="mt-4 grid grid-cols-3 gap-3">
          <button class="btn btn-ghost border" onclick="mockPay('${eventId}', '${name}', ${qty}, '${ticket}', ${amount}, 'UPI')">UPI</button>
          <button class="btn btn-ghost border" onclick="mockPay('${eventId}', '${name}', ${qty}, '${ticket}', ${amount}, 'CARD')">Card</button>
          <button class="btn btn-ghost border" onclick="mockPay('${eventId}', '${name}', ${qty}, '${ticket}', ${amount}, 'NET')">NetBanking</button>
        </div>
        <button class="btn btn-ghost mt-4" onclick="navigate('#/register/${eventId}')">Back</button>
      </div>`;
  }

  window.mockPay = function(eventId, name, qty, ticket, amount, method){
    const e = db.events.find(x=>x.id===eventId);
    const reg = { id: uid(), user_email: session.email, name, ticket, qty, paid:true, amount, method, created_at: new Date().toISOString() };
    e.participants.push(reg);
    e.updated_at = new Date().toISOString();
    persist();

    view.innerHTML = `
      <div class="max-w-lg mx-auto card text-center">
        <div class="mx-auto w-12 h-12 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center"><i data-lucide=check class=w-7 h-7></i></div>
        <h2 class="text-2xl font-extrabold mt-3">Payment Successful</h2>
        <p class="text-slate-600">Your registration is confirmed.</p>
        <div class="mt-4 text-left bg-slate-50 border rounded-xl p-4">
          <div class="font-semibold">Ticket</div>
          <div class="text-sm mt-1">Event: ${e.title}<br/>Name: ${name}<br/>Qty: ${qty}<br/>Ticket: ${ticket}<br/>Amount: ₹${amount.toFixed(2)}<br/>Txn: ${reg.id}</div>
        </div>
        <button class="btn btn-primary mt-4" onclick="navigate('#/')">Go Home</button>
      </div>`;
    setToast('Registered successfully');
    lucide.createIcons();
  }

  // --------------------
  // Dashboard (Organiser-only)
  // --------------------
  route('#/dashboard', ()=>{
    if(!requireAuth()) return;
    const role = session.role;

    if(role==='organiser'){
      const myEvents = db.events.filter(e=> e.organiser_email===session.email);
      view.innerHTML = `
        <div class="flex items-start justify-between gap-4 mb-4">
          <div>
            <h2 class="text-2xl font-extrabold">Dashboard — Organiser</h2>
            <p class="text-slate-600">Create and manage <b>your</b> events. You cannot access others' events.</p>
          </div>
          <button class="btn btn-primary" onclick="openEventModal()"><i data-lucide=plus class=w-4 h-4></i>Create Event</button>
        </div>

        <div class="grid gap-6">
          <div class="card overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600">
                  <th class="py-2">Event</th>
                  <th>Date/Time</th>
                  <th>Venue</th>
                  <th>Max</th>
                  <th>Registered</th>
                  <th>Slots Left</th>
                  <th>Status</th>
                  <th class="text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${myEvents.map(renderEventRow).join('') || `<tr><td colspan=8 class="py-6 text-center text-slate-500">No events yet</td></tr>`}
              </tbody>
            </table>
          </div>

          <div class="card">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-bold">Registrations over time</h3>
              <span class="text-xs text-slate-500">Bar + Line</span>
            </div>
            <canvas id="regChart" height="120"></canvas>
          </div>
        </div>

        <dialog id="eventModal" class="p-0 rounded-2xl w-full max-w-2xl"></dialog>
      `;
      lucide.createIcons();
      renderRegChart(myEvents);
    } else if(role==='student'){
      // Student: show my registrations
      const regs = db.events.flatMap(e=> e.participants.filter(p=>p.user_email===session.email).map(p=> ({e,p})) );
      view.innerHTML = `
        <div>
          <h2 class="text-2xl font-extrabold">My Registrations</h2>
          <div class="mt-4 card">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left text-slate-600">
                  <th>Event</th><th>Date</th><th>Venue</th><th>Qty</th><th>Amount</th><th>Txn</th>
                </tr>
              </thead>
              <tbody>
                ${regs.map(r=>`<tr>
                  <td class="py-2 font-semibold">${r.e.title}</td>
                  <td>${new Date(r.e.date_time).toLocaleString()}</td>
                  <td>${r.e.venue}</td>
                  <td>${r.p.qty}</td>
                  <td>₹${r.p.amount.toFixed(2)}</td>
                  <td>${r.p.id}</td>
                </tr>`).join('') || `<tr><td colspan=6 class="py-6 text-center text-slate-500">No registrations yet</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>`;
    } else {
      view.innerHTML = emptyState('Unknown role');
    }
  })

  function renderRegChart(myEvents){
    const map = new Map();
    myEvents.forEach(e=>{
      e.participants.forEach(p=>{
        if(!p.paid) return;
        const d = new Date(p.created_at);
        const k = d.getFullYear()+ '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        map.set(k, (map.get(k)||0) + (p.qty||1));
      })
    })
    const labels = Array.from(map.keys()).sort();
    const data = labels.map(k=> map.get(k));
    const ctx = document.getElementById('regChart');
    if(!ctx) return;
    if(window.__regChart) window.__regChart.destroy();
    window.__regChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [ { type:'bar', label:'Registrations', data }, { type:'line', label:'Trend', data, tension:0.3 } ] },
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderEventRow(e){
    const regCount = e.participants.filter(p=>p.paid).reduce((a,b)=>a+(b.qty||1),0);
    const slotsLeft = Math.max(0, (e.max||0) - regCount);
    return `<tr class="border-t">
      <td class="py-2"><div class="font-semibold">${e.title}</div><div class="text-slate-500">${e.category||'General'}</div></td>
      <td>${new Date(e.date_time).toLocaleString()}</td>
      <td>${e.venue}</td>
      <td>${e.max}</td>
      <td>${regCount}</td>
      <td>${slotsLeft}</td>
      <td>${e.is_published? 'Published' : 'Draft'}</td>
      <td class="text-right">
        <div class="inline-flex gap-2">
          <button class="btn btn-ghost" onclick="openParticipants('${e.id}')"><i data-lucide=users class=w-4 h-4></i>Participants</button>
          <button class="btn btn-ghost" onclick="openEventModal('${e.id}')"><i data-lucide=pencil class=w-4 h-4></i>Edit</button>
          <button class="btn btn-ghost" onclick="togglePublish('${e.id}')"><i data-lucide=megaphone class=w-4 h-4></i>${e.is_published?'Unpublish':'Publish'}</button>
          <button class="btn btn-ghost text-rose-600" onclick="deleteEvent('${e.id}')"><i data-lucide=trash2 class=w-4 h-4></i>Delete</button>
        </div>
      </td>
    </tr>`
  }

  // Create/Edit Event Modal
  window.openEventModal = function(id){
    const isEdit = !!id;
    const e = isEdit ? db.events.find(x=>x.id===id) : { title:'', description:'', category:'', date_time:new Date().toISOString().slice(0,16), venue:'', max:0, is_published:false };
    const dlg = $('#eventModal');
    dlg.innerHTML = `
      <form method="dialog" class="card rounded-2xl">
        <h3 class="text-xl font-bold">${isEdit?'Edit':'Create'} Event</h3>
        <div class="grid sm:grid-cols-2 gap-3 mt-3">
          ${field('ev_title','Title','text',`value="${e.title}"`)}
          ${field('ev_category','Category','text',`value="${e.category||''}"`)}
          <label class="block text-sm font-medium">Date & Time
            <input id="ev_date" type="datetime-local" class="input mt-1" value="${(isEdit? new Date(e.date_time) : new Date()).toISOString().slice(0,16)}" />
          </label>
          ${field('ev_venue','Venue','text',`value="${e.venue}"`)}
          ${field('ev_max','Max Participants','number',`min=1 value="${e.max||0}"`)}
        </div>
        <label class="block text-sm font-medium mt-3">Description
          <textarea id="ev_desc" class="input mt-1" rows="3">${e.description||''}</textarea>
        </label>
        <div class="mt-4 flex items-center justify-end gap-2">
          <button class="btn btn-ghost">Cancel</button>
          <button class="btn btn-primary" onclick="saveEvent('${id||''}');return false;">Save</button>
        </div>
      </form>`;
    dlg.showModal();
    lucide.createIcons();
  }

  window.saveEvent = function(id){
    const title = $('#ev_title').value.trim();
    const category = $('#ev_category').value.trim();
    const date_time = new Date($('#ev_date').value).toISOString();
    const venue = $('#ev_venue').value.trim();
    const max = Math.max(1, parseInt($('#ev_max').value||'1'));
    const description = $('#ev_desc').value.trim();
    if(!title){ setToast('Title is required', false); return }

    if(id){
      const e = db.events.find(x=>x.id===id);
      if(e.organiser_email!==session.email){ setToast('Forbidden: not your event', false); return }
      Object.assign(e,{title,category,date_time,venue,max,description,updated_at:new Date().toISOString()});
    } else {
      db.events.push({ id:uid(), title, category, date_time, venue, max, description, organiser_email: session.email, is_published:false, participants:[], created_at:new Date().toISOString(), updated_at:new Date().toISOString() });
    }
    persist();
    $('#eventModal').close();
    setToast('Saved');
    render();
  }

  window.togglePublish = function(id){
    const e = db.events.find(x=>x.id===id);
    if(e.organiser_email!==session.email){ setToast('Forbidden', false); return }
    e.is_published = !e.is_published; e.updated_at=new Date().toISOString(); persist(); render();
  }
  window.deleteEvent = function(id){
    const e = db.events.find(x=>x.id===id);
    if(e.organiser_email!==session.email){ setToast('Forbidden', false); return }
    if(!confirm('Delete this event?')) return;
    db.events.splice(db.events.findIndex(x=>x.id===id),1); persist(); render();
  }

  // Participants view & export (organiser only, own events)
  window.openParticipants = function(id){
    const e = db.events.find(x=>x.id===id);
    if(e.organiser_email!==session.email){ setToast('Forbidden', false); return }
    const rows = e.participants.map(p=>`<tr class="border-t"><td class="py-2">${p.name}</td><td>${p.user_email}</td><td>${p.ticket}</td><td>${p.qty}</td><td>${p.paid?'Paid':'Unpaid'}</td><td>₹${p.amount.toFixed(2)}</td><td>${new Date(p.created_at).toLocaleString()}</td></tr>`).join('') || `<tr><td colspan=7 class="py-4 text-center text-slate-500">No participants yet</td></tr>`;

    const dlg = document.createElement('dialog');
    dlg.className = 'p-0 rounded-2xl w-full max-w-4xl';
    dlg.innerHTML = `
      <form method="dialog" class="card">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold">Participants — ${e.title}</h3>
          <div class="flex gap-2">
            <button class="btn btn-ghost" onclick="exportCSV('${id}');return false;"><i data-lucide=download class=w-4 h-4></i>CSV</button>
            <button class="btn btn-primary" onclick="exportXLSX('${id}');return false;"><i data-lucide=file-spreadsheet class=w-4 h-4></i>Excel</button>
          </div>
        </div>
        <div class="overflow-auto max-h-[60vh] mt-3">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-slate-600"><th>Name</th><th>Email</th><th>Ticket</th><th>Qty</th><th>Status</th><th>Amount</th><th>Registered At</th></tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
        <div class="mt-4 text-right"><button class="btn btn-ghost">Close</button></div>
      </form>`;
    document.body.appendChild(dlg); dlg.showModal();
    dlg.addEventListener('close', ()=> dlg.remove());
    lucide.createIcons();
  }

  window.exportCSV = function(eventId){
    const e = db.events.find(x=>x.id===eventId);
    const rows = e.participants.map(p=>({
      Event: e.title,
      Name: p.name,
      Email: p.user_email,
      Ticket: p.ticket,
      Quantity: p.qty,
      PaymentStatus: p.paid?'Paid':'Unpaid',
      Amount: p.amount,
      RegisteredAt: p.created_at,
      TxnId: p.id
    }));
    const csv = [Object.keys(rows[0]||{Event:'',Name:'',Email:'',Ticket:'',Quantity:0,PaymentStatus:'',Amount:0,RegisteredAt:'',TxnId:''}).join(','), ...rows.map(r=>Object.values(r).map(v=>`"${String(v).replaceAll('"','""')}"`).join(','))].join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${slug(e.title)}-participants.csv`; a.click(); URL.revokeObjectURL(a.href);
  }

  window.exportXLSX = function(eventId){
    const e = db.events.find(x=>x.id===eventId);
    const rows = e.participants.map(p=>({
      Event: e.title,
      Name: p.name,
      Email: p.user_email,
      Ticket: p.ticket,
      Quantity: p.qty,
      PaymentStatus: p.paid?'Paid':'Unpaid',
      Amount: p.amount,
      RegisteredAt: new Date(p.created_at).toLocaleString(),
      TxnId: p.id
    }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Participants');
    XLSX.writeFile(wb, `${slug(e.title)}-participants.xlsx`);
  }

  function slug(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') }

  // --------------
  // Router Engine
  // --------------
  function matchRoute(){
    const hash = location.hash || '#/'
    for(const pattern in routes){
      const params = {};
      if(pattern.includes('/:')){
        const p1 = pattern.split('/:');
        const base = p1[0];
        const rest = p1[1];
        if(hash.startsWith(base)){
          const seg = hash.slice(base.length+1); // remove '#/.../'
          if(seg){ params[rest] = seg }
          return { handler: routes[pattern], params };
        }
      } else if(hash.split('?')[0]===pattern){
        return { handler: routes[pattern], params:{} };
      }
    }
    return { handler: routes['#/'], params:{} };
  }

  function render(){
    const {handler, params} = matchRoute();
    handler(params);
    renderHeader();
  }

  // --------------------
  // Minimal Test Suite (run via #/tests or ?runTests=1)
  // --------------------
  route('#/tests', ()=>{
    const results = [];

    function assert(name, fn){
      try { fn(); results.push({name, ok:true}); }
      catch(err){ results.push({name, ok:false, err: String(err)}) }
    }

    // Snapshot state to avoid polluting real data
    const usersBackup = JSON.parse(JSON.stringify(users));
    const sessionBackup = JSON.parse(JSON.stringify(session));

    // Tests
    assert('slug("Hello, World!") → "hello-world"', ()=>{
      if(slug('Hello, World!') !== 'hello-world') throw new Error('slug failed');
    });

    assert('uid() generates 100 unique IDs', ()=>{
      const set = new Set(Array.from({length:100}, ()=> uid()));
      if(set.size !== 100) throw new Error('uid not unique');
    });

    assert('signIn with bad credentials throws', ()=>{
      let threw = false; try { signIn({email:'no@no.com', password:'x'}) } catch { threw = true }
      if(!threw) throw new Error('expected throw');
    });

    assert('requireAuth when logged out returns false and redirects', ()=>{
      const oldHash = location.hash;
      session = null; persist();
      const ok = requireAuth('student');
      if(ok) throw new Error('should be false');
      if(location.hash !== '#/login') throw new Error('did not navigate to login');
      navigate(oldHash);
    });

    // Restore state
    Object.assign(users, usersBackup);
    session = sessionBackup; persist();

    const passed = results.filter(r=>r.ok).length;
    const failed = results.length - passed;

    view.innerHTML = `
      <div class="card">
        <h2 class="text-xl font-bold">Test Results</h2>
        <p class="text-sm text-slate-600">${passed} passed, ${failed} failed</p>
        <ul class="mt-3 space-y-1 text-sm">
          ${results.map(r=> `<li>${r.ok ? '✅' : '❌'} ${r.name} ${r.ok ? '' : '— '+r.err}</li>`).join('')}
        </ul>
        <div class="mt-4"><a class="btn btn-primary" href="#/">Back to app</a></div>
      </div>`;
  });

  // Auto-run tests if query has ?runTests=1
  try {
    if(new URL(location.href).searchParams.get('runTests') === '1') navigate('#/tests');
  } catch {}

  // Init
  $('#year').textContent = new Date().getFullYear();
  render();
  </script>
</body>
</html>